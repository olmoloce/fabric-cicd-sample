name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  STORAGE_ACCOUNT: ${{ vars.CODE_STORAGE_ACCOUNT }}
  FABRIC_DEPLOYMENT_HUB_URL: ${{ vars.FABRIC_DEPLOYMENT_HUB_URL }}
  WORKSPACE_IDS: ${{ vars.WORKSPACE_IDS }}

jobs:
  build:
    runs-on: self-hosted

    steps:
      # Step 1: Check out the repository
      - name: Check out the code
        uses: actions/checkout@v4

      # Step 1.1: Ensure Git is installed
      - name: Check if Git is installed
        run: |
          if command -v git &> /dev/null; then
            echo "Git is installed."
            git --version
          else
            echo "Git is not installed."
            exit 1
          fi
        shell: bash

      # Step 2: Identify modified folders
      - name: Identify modified folders
        id: modified_folders
        run: |
          if git rev-parse HEAD^ &> /dev/null; then
            echo "Fetching modified folders between HEAD and HEAD^..."
            MODIFIED_FOLDERS=$(git diff --name-only HEAD^ HEAD | cut -d'/' -f1 | sort | uniq)
          else
            echo "No previous commit found. Fetching modified folders for HEAD..."
            MODIFIED_FOLDERS=$(git ls-tree --name-only -r HEAD | cut -d'/' -f1 | sort | uniq)
          fi
          echo "Modified folders detected: $MODIFIED_FOLDERS"
          echo "folders=$MODIFIED_FOLDERS" >> $GITHUB_ENV
        shell: bash

      # Step 3: Authenticate with Azure using Managed Identity
      - name: Authenticate with Azure
        run: |
          az login --identity

      # Step 4: Create a blob container with a GUID
      - name: Generate container name
        id: container
        run: |
          GENERATED_CONTAINER=$(uuidgen)
          echo "Generated container name: $GENERATED_CONTAINER"
          echo "container_name=$GENERATED_CONTAINER" >> $GITHUB_ENV
        shell: bash

      # Step 5: Upload repository to shared storage
      - name: Upload repository to shared storage
        run: |
          az storage container create \
            --account-name "${{ env.STORAGE_ACCOUNT }}" \
            --name "$container_name" \
            --auth-mode login
          azcopy copy "$GITHUB_WORKSPACE" "https://${{ env.STORAGE_ACCOUNT }}.blob.core.windows.net/$container_name" --recursive
        env:
          container_name: ${{ env.container_name }}

      # Step 6: Call the deployment API
      - name: Call Deployment API
        run: |
          curl -X POST "https://$FABRIC_DEPLOYMENT_HUB_URL/api/Planner/tenant-deployment-plan" \
            -H "Content-Type: application/json" \
            -d '{
              "workspaceIds": [${{ env.WORKSPACE_IDS }}],
              "repoContainer": "'$container_name'",
              "modifiedFolders": ["'$MODIFIED_FOLDERS'"]
            }'